---
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-create-proxy-user
  namespace: bordspelplatform-8
spec:
  ttlSecondsAfterFinished: 120
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: setup
        image: alpine:3.19
        command: ["sh","-c"]
        args:
          - |
            set -e
            apk add --no-cache curl jq >/dev/null
            KC="http://keycloak-service:8180"
            REALM="boardgame-platform"
            # Get admin token from master realm
            ADMIN_TOKEN=$(curl -s -X POST "$KC/realms/master/protocol/openid-connect/token" \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "username=$KEYCLOAK_ADMIN" \
              -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
              -d "grant_type=password" \
              -d "client_id=admin-cli" | jq -r .access_token)
            if [ -z "$ADMIN_TOKEN" ] || [ "$ADMIN_TOKEN" = "null" ]; then
              echo "Failed to obtain admin token"; exit 1;
            fi
            # Check user exists
            EXIST=$(curl -s -X GET "$KC/admin/realms/$REALM/users?username=$PROXY_USER" -H "Authorization: Bearer $ADMIN_TOKEN" | jq 'length')
            if [ "$EXIST" = "0" ]; then
              echo "Creating user $PROXY_USER in realm $REALM"
              curl -s -X POST "$KC/admin/realms/$REALM/users" \
                -H "Authorization: Bearer $ADMIN_TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"$PROXY_USER\",\"enabled\":true}" -o /dev/null -w "Status: %{http_code}\n"
            else
              echo "User $PROXY_USER already exists"
            fi
            # Fetch user id
            USER_ID=$(curl -s -X GET "$KC/admin/realms/$REALM/users?username=$PROXY_USER" -H "Authorization: Bearer $ADMIN_TOKEN" | jq -r '.[0].id')
            if [ -z "$USER_ID" ] || [ "$USER_ID" = "null" ]; then
              echo "Failed to resolve user id"; exit 1;
            fi
            # Set password
            echo "Setting password for $PROXY_USER"
            curl -s -X PUT "$KC/admin/realms/$REALM/users/$USER_ID/reset-password" \
              -H "Authorization: Bearer $ADMIN_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"type\":\"password\",\"value\":\"$PROXY_PASSWORD\",\"temporary\":false}" -o /dev/null -w "Status: %{http_code}\n"
        env:
        - name: KEYCLOAK_ADMIN
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: KEYCLOAK_ADMIN
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: KEYCLOAK_ADMIN_PASSWORD
        - name: PROXY_USER
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: PROXY_USER
        - name: PROXY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: platform-secrets
              key: PROXY_PASSWORD
