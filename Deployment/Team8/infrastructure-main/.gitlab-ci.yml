stages:
  - validate
  - test

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Validate docker-compose configuration syntax
validate-docker-compose:
  stage: validate
  image: docker:24-cli
  services:
    - docker:24-dind
  before_script:
    - apk add --no-cache docker-cli-compose
    - mkdir -p ../frontend-platform ../frontend-blokus ../backend-platform-service ../backend-game-service
  script:
    - echo "Validating docker-compose.yml syntax..."
    - docker compose config --quiet
    - echo "✓ Docker Compose configuration is valid"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH
# Validate nginx configuration
validate-nginx:
  stage: validate
  image: alpine:latest
  script:
    - echo "Checking nginx.conf exists..."
    - test -f nginx/nginx.conf && echo "✓ nginx/nginx.conf found" || (echo "✗ nginx/nginx.conf not found" && exit 1)
    - echo "Checking for basic nginx structure..."
    - grep -E 'server.*\{' nginx/nginx.conf > /dev/null && echo "✓ Server blocks found" || (echo "✗ No server blocks found" && exit 1)
    - grep -E 'upstream.*\{' nginx/nginx.conf > /dev/null && echo "✓ Upstream blocks found" || (echo "✗ No upstream blocks found" && exit 1)
    - echo "Checking for balanced braces..."
    - test $(grep -o '{' nginx/nginx.conf | wc -l) -eq $(grep -o '}' nginx/nginx.conf | wc -l) && echo "✓ Braces are balanced" || (echo "✗ Unmatched braces" && exit 1)
    - echo "✓ Nginx configuration looks valid"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH

# Check for common issues
lint-configs:
  stage: validate
  image: alpine:latest
  script:
    - echo "Checking configuration files..."
    - test -f docker-compose.yml && echo "✓ docker-compose.yml found" || (echo "✗ docker-compose.yml not found" && exit 1)
    - test -f nginx/nginx.conf && echo "✓ nginx/nginx.conf found" || (echo "✗ nginx/nginx.conf not found" && exit 1)
    - echo "✓ All basic checks passed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_DEFAULT_BRANCH == $CI_COMMIT_BRANCH

include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/SAST-IaC.gitlab-ci.yml