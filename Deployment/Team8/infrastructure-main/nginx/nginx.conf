events { worker_connections 1024; }

http {
    upstream ui-platform { server frontend-platform:80; }
    upstream ui-blokus   { server frontend-blokus:80; }
    upstream api-platform { server backend-platform:8080; }
    upstream api-game     { server backend-game:8080; }
    upstream api-ai       { server ai-player:8000; }

    server {
        listen 80;
        server_name localhost;

        # 1. Platform Config (Root)
        location = /config.json {
            proxy_pass http://ui-platform/config.json;
            add_header Cache-Control "no-store, no-cache";
        }

        # 2. Blokus Config
        # Omdat blokus base='/blokus/' heeft, fetcht hij './config.json' -> '/blokus/config.json'
        location = /blokus/config.json {
            # Stuur door naar de root van de blokus container (waar env.sh het bestand maakte)
            proxy_pass http://ui-blokus/config.json;
            add_header Cache-Control "no-store, no-cache";
        }

        # 3. Blokus App
        location /blokus/ {
            proxy_pass http://ui-blokus;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            # Zorg dat websockets (voor hot reload als je ooit lokaal devt) en headers goed staan
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 4. Platform App (Fallback)
        location / {
            proxy_pass http://ui-platform;
            proxy_set_header Host $host;
        }

        # 5. APIs
        location /api/platform/ {
            rewrite ^/api/platform/(.*) /api/$1 break;
            proxy_pass http://api-platform;
            proxy_set_header Host $host;
        }

        location /api/games/ {
            proxy_pass http://api-game;
            proxy_set_header Host $host;
        }

        # 6. AI Service  <-- ADD THIS ENTIRE BLOCK
        location /api/ai/ {
            rewrite ^/api/ai/(.*) /$1 break;
            proxy_pass http://api-ai;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
        }
    }
}